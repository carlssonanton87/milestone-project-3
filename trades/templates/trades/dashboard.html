{% extends 'trades/base.html' %}
{% block content %}

<h2 class="mb-4">Trading Dashboard</h2>

<!-- Filter Row: Side-by-Side Equal Width -->
<div class="row mb-4 g-3 align-items-start">

  <!-- Left Column: Preset Buttons (6/12 columns = 50%) -->
  <div class="col-12 col-md-6">
    <div class="d-flex flex-wrap gap-2">
      <a href="?range=today" class="btn btn-outline-secondary btn-sm">Today</a>
      <a href="?range=yesterday" class="btn btn-outline-secondary btn-sm">Yesterday</a>
      <a href="?range=this_week" class="btn btn-outline-secondary btn-sm">This wk.</a>
      <a href="?range=last_week" class="btn btn-outline-secondary btn-sm">Last wk.</a>
      <a href="?range=this_month" class="btn btn-outline-secondary btn-sm">This mo.</a>
      <a href="?range=last_month" class="btn btn-outline-secondary btn-sm">Last mo.</a>
      <a href="?range=last_3_months" class="btn btn-outline-secondary btn-sm">Last 3 mo.</a>
      <a href="?range=this_year" class="btn btn-outline-secondary btn-sm">This yr.</a>
      <a href="?range=last_year" class="btn btn-outline-secondary btn-sm">Last yr.</a>
      <a href="?range=all" class="btn btn-outline-dark btn-sm">Reset</a>
    </div>
  </div>

  <!-- Right Column: Slider (6/12 columns = 50%) -->
  <div class="col-12 col-md-6">
    <form method="get" id="slider-form">
      <input type="hidden" name="start" id="start">
      <input type="hidden" name="end" id="end">

    
      <div id="date-slider"></div>
      <div class="d-flex justify-content-between mt-1 text-muted">
        <small id="slider-start-label">Start</small>
        <small id="slider-end-label">End</small>
      </div>
    </form>
  </div>

</div>













<div class="row text-center">
  <!-- Total Trades -->
<div class="col-md-4 mb-4">
  <div class="card bg-primary text-white">
    <div class="card-body">
      <h5><i class="bi bi-clipboard-data me-2"></i>Total Trades</h5>
      <p class="fs-4">{{ total_trades }}</p>
    </div>
  </div>
</div>

<!-- Win Rate -->
<div class="col-md-4 mb-4">
  <div class="card bg-success text-white">
    <div class="card-body">
      <h5><i class="bi bi-trophy me-2"></i>Win Rate</h5>
      <p class="fs-4">{{ win_rate }}%</p>
    </div>
  </div>
</div>

<!-- Average Return -->
<div class="col-md-4 mb-4">
  <div class="card bg-warning text-dark">
    <div class="card-body">
      <h5><i class="bi bi-graph-up-arrow me-2"></i>Average Return</h5>
      <p class="fs-4">{{ avg_return }}%</p>
    </div>
  </div>
</div>

<!-- Average Holding Time -->
<div class="col-md-6 mb-4">
  <div class="card bg-info text-dark">
    <div class="card-body">
      <h5><i class="bi bi-clock-history me-2"></i>Average Holding Time</h5>
      <p class="fs-4">{{ avg_holding }} days</p>
    </div>
  </div>
</div>

<!-- Open vs Closed -->
<div class="col-md-6 mb-4">
  <div class="card bg-dark text-white">
    <div class="card-body">
      <h5><i class="bi bi-bar-chart-line me-2"></i>Open vs Closed</h5>
      <p class="fs-4">{{ open_trades }} open / {{ closed_trades }} closed</p>
    </div>
  </div>
</div>

</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const slider = document.getElementById('date-slider');

  // Just in case the element isn't found
  if (!slider || typeof noUiSlider === 'undefined') {
    console.warn("Slider not found or noUiSlider not loaded");
    return;
  }

  const startDate = new Date("2025-01-01").getTime();
  const endDate = new Date().getTime();

  const params = new URLSearchParams(window.location.search);
if (params.get('range') === 'all') {
  params.delete('start');
  params.delete('end');
  history.replaceState(null, '', '?' + params.toString());
}

  noUiSlider.create(slider, {
    start: [startDate, endDate],
    connect: true,
    range: {
      min: startDate,
      max: endDate
    },
    step: 24 * 60 * 60 * 1000,
    tooltips: [true, true],
    format: {
  to: ts => {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return ''; // protect against "all" or bad values
    return d.toISOString().split('T')[0];
  },
  from: str => {
    const t = new Date(str).getTime();
    return isNaN(t) ? null : t;
  }
}

  });

  const startLabel = document.getElementById('slider-start-label');
  const endLabel = document.getElementById('slider-end-label');

  slider.noUiSlider.on('change', function (values) {
    const start = values[0];
    const end = values[1];

    startLabel.textContent = start;
    endLabel.textContent = end;

    const params = new URLSearchParams(window.location.search);
    params.set('start', start);
    params.set('end', end);
    window.location.search = params.toString();
  });
});
</script>
{% endblock %}
